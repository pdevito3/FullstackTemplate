{
  "apiVersion": "v1.2",
  "arguments": {
    "PROJECT_NAME": "fullstack-template",
    "PROJECT_REGION": "us-central",
    "GIT_REPO": "TODO: Insert your git repo URL here",
    "GIT_BRANCH": "main",
//#if (UseDuendeDemo)
    "AUTH_AUTHORITY": "https://demo.duendesoftware.com",
    "AUTH_CLIENT_ID": "interactive.confidential",
    "AUTH_CLIENT_SECRET": "secret",
    "AUTH_AUDIENCE": "api"
//#endif
//#if (UseFusionAuth)
    "AUTH_AUTHORITY": "TODO: Insert your FusionAuth authority URL here",
    "AUTH_CLIENT_ID": "e9fdb985-9173-4e01-9d73-ac2d60d1dc8e",
    "AUTH_CLIENT_SECRET": "super-secret-client-secret-change-in-production",
    "AUTH_AUDIENCE": "e9fdb985-9173-4e01-9d73-ac2d60d1dc8e"
//#endif
//#if (UseKeycloak)
    "AUTH_AUTHORITY": "TODO: Insert your Keycloak authority URL here (e.g., https://your-keycloak.com/realms/aspire)",
    "AUTH_CLIENT_ID": "aspire-app",
    "AUTH_CLIENT_SECRET": "super-secret-client-secret-change-in-production",
    "AUTH_AUDIENCE": "aspire-app"
//#endif
//#if (UseAuthentik)
    "AUTHENTIK_BASE_URL": "TODO: See post-deployment setup - set to https://authentik-server--{project-name}.{region}.northflank.app",
    "AUTH_CLIENT_ID": "aspire-app",
    "AUTH_CLIENT_SECRET": "super-secret-client-secret-change-in-production",
    "AUTH_AUDIENCE": "aspire-app",
    "AUTHENTIK_BOOTSTRAP_PASSWORD": "change-me-in-production",
    "AUTHENTIK_BOOTSTRAP_EMAIL": "admin@example.com"
//#endif
  },
  "spec": {
    "kind": "Workflow",
    "spec": {
      "type": "sequential",
      "steps": [
        {
          "kind": "Project",
          "ref": "project",
          "spec": {
            "name": "${args.PROJECT_NAME}",
            "region": "${args.PROJECT_REGION}",
            "networking": {
              "allowedIngressProjects": []
            }
          }
        },
        {
          "kind": "Workflow",
          "spec": {
            "type": "sequential",
            "context": {
              "projectId": "${refs.project.id}"
            },
            "steps": [
              {
                "kind": "Addon",
                "ref": "postgres",
                "spec": {
                  "name": "postgres",
                  "type": "postgresql",
                  "version": "17",
                  "billing": {
                    "replicas": 1,
                    "storage": 4096,
                    "deploymentPlan": "nf-compute-20"
                  },
                  "tlsEnabled": true,
                  "externalAccessEnabled": false
                }
              },
//#if (UseAuthentik)
              {
                "kind": "Addon",
                "ref": "postgres-authentik",
                "spec": {
                  "name": "postgres-authentik",
                  "type": "postgresql",
                  "version": "16",
                  "billing": {
                    "replicas": 1,
                    "storage": 4096,
                    "deploymentPlan": "nf-compute-20"
                  },
                  "tlsEnabled": true,
                  "externalAccessEnabled": false
                }
              },
              {
                "kind": "Addon",
                "ref": "redis-authentik",
                "spec": {
                  "name": "redis-authentik",
                  "type": "redis",
                  "version": "7.2",
                  "billing": {
                    "replicas": 1,
                    "storage": 1024,
                    "deploymentPlan": "nf-compute-20"
                  },
                  "tlsEnabled": true,
                  "externalAccessEnabled": false
                }
              },
//#endif
              {
                "kind": "SecretGroup",
                "ref": "secrets",
                "spec": {
                  "name": "app-secrets",
                  "secretType": "environment-arguments",
                  "priority": 10,
                  "secrets": {
                    "variables": {
                      "Auth__ClientId": "${args.AUTH_CLIENT_ID}",
                      "Auth__ClientSecret": "${args.AUTH_CLIENT_SECRET}",
                      "Auth__Audience": "${args.AUTH_AUDIENCE}",
//#if (UseDuendeDemo)
                      "Auth__Authority": "${args.AUTH_AUTHORITY}",
                      "Auth__RequireHttpsMetadata": "true",
                      "Auth__NameClaimType": "name",
                      "Auth__RoleClaimType": "role",
                      "Auth__RevokeRefreshTokenOnLogout": "true",
//#endif
//#if (UseFusionAuth)
                      "Auth__Authority": "${args.AUTH_AUTHORITY}",
                      "Auth__RequireHttpsMetadata": "true",
                      "Auth__NameClaimType": "email",
                      "Auth__RoleClaimType": "roles",
                      "Auth__RevokeRefreshTokenOnLogout": "false",
//#endif
//#if (UseKeycloak)
                      "Auth__Authority": "${args.AUTH_AUTHORITY}",
                      "Auth__RequireHttpsMetadata": "true",
                      "Auth__NameClaimType": "email",
                      "Auth__RoleClaimType": "roles",
                      "Auth__RevokeRefreshTokenOnLogout": "true",
//#endif
//#if (UseAuthentik)
                      "Auth__Authority": "${args.AUTHENTIK_BASE_URL}/application/o/aspire-app/",
                      "Auth__RequireHttpsMetadata": "true",
                      "Auth__NameClaimType": "email",
                      "Auth__RoleClaimType": "roles",
                      "Auth__RevokeRefreshTokenOnLogout": "true",
//#endif
                      "ASPNETCORE_ENVIRONMENT": "Production"
                    },
                    "files": {}
                  },
                  "addonDependencies": [
                    {
                      "addonId": "${refs.postgres.id}",
                      "keys": [
                        {
                          "keyName": "POSTGRES_URI",
                          "aliases": [
                            "ConnectionStrings__appdb"
                          ]
                        }
                      ]
                    }
                  ],
                  "restrictions": {
                    "restricted": false,
                    "nfObjects": [],
                    "tags": []
                  }
                }
              },
//#if (UseAuthentik)
              {
                "kind": "SecretGroup",
                "ref": "authentik-secrets",
                "spec": {
                  "name": "authentik-secrets",
                  "secretType": "environment-arguments",
                  "priority": 10,
                  "secrets": {
                    "variables": {},
                    "files": {}
                  },
                  "addonDependencies": [
                    {
                      "addonId": "${refs.postgres-authentik.id}",
                      "keys": [
                        {
                          "keyName": "POSTGRES_HOST",
                          "aliases": ["AUTHENTIK_POSTGRESQL__HOST"]
                        },
                        {
                          "keyName": "POSTGRES_PORT",
                          "aliases": ["AUTHENTIK_POSTGRESQL__PORT"]
                        },
                        {
                          "keyName": "POSTGRES_DATABASE",
                          "aliases": ["AUTHENTIK_POSTGRESQL__NAME"]
                        },
                        {
                          "keyName": "POSTGRES_USERNAME",
                          "aliases": ["AUTHENTIK_POSTGRESQL__USER"]
                        },
                        {
                          "keyName": "POSTGRES_PASSWORD",
                          "aliases": ["AUTHENTIK_POSTGRESQL__PASSWORD"]
                        }
                      ]
                    },
                    {
                      "addonId": "${refs.redis-authentik.id}",
                      "keys": [
                        {
                          "keyName": "REDIS_MASTER_URL",
                          "aliases": ["AUTHENTIK_REDIS__URL"]
                        }
                      ]
                    }
                  ],
                  "restrictions": {
                    "restricted": true,
                    "nfObjects": [
                      {
                        "id": "${refs.authentik-server.id}",
                        "type": "service"
                      },
                      {
                        "id": "${refs.authentik-worker.id}",
                        "type": "service"
                      }
                    ],
                    "tags": []
                  }
                }
              },
//#endif
              {
                "kind": "CombinedService",
                "ref": "server",
                "spec": {
                  "name": "server",
                  "billing": {
                    "deploymentPlan": "nf-compute-10",
                    "buildPlan": "nf-compute-400-16"
                  },
                  "deployment": {
                    "instances": 1,
                    "storage": {
                      "ephemeralStorage": {
                        "storageSize": 1024
                      },
                      "shmSize": 64
                    },
                    "docker": {
                      "configType": "default"
                    }
                  },
                  "vcsData": {
                    "projectType": "github",
                    "projectUrl": "${args.GIT_REPO}",
                    "projectBranch": "${args.GIT_BRANCH}"
                  },
                  "buildSettings": {
                    "dockerfile": {
                      "buildEngine": "kaniko",
                      "dockerFilePath": "/FullstackTemplate.Server/Dockerfile",
                      "dockerWorkDir": "/"
                    }
                  },
                  "ports": [
                    {
                      "name": "http",
                      "internalPort": 8080,
                      "protocol": "HTTP",
                      "public": false,
                      "security": {
                        "credentials": [],
                        "policies": [],
                        "sso": {}
                      }
                    }
                  ],
                  "healthChecks": [
                    {
                      "type": "livenessProbe",
                      "protocol": "HTTP",
                      "path": "/health",
                      "port": 8080,
                      "initialDelaySeconds": 10,
                      "periodSeconds": 30,
                      "timeoutSeconds": 5,
                      "failureThreshold": 3
                    }
                  ],
                  "runtimeEnvironment": {},
                  "runtimeFiles": {},
                  "buildArguments": {},
                  "buildFiles": {},
                  "disabledCI": false,
                  "buildConfiguration": {
                    "pathIgnoreRules": [],
                    "isAllowList": false,
                    "ciIgnoreFlagsEnabled": false
                  }
                }
              },
              {
                "kind": "CombinedService",
                "ref": "bff",
                "spec": {
                  "name": "bff",
                  "billing": {
                    "deploymentPlan": "nf-compute-10",
                    "buildPlan": "nf-compute-400-16"
                  },
                  "deployment": {
                    "instances": 1,
                    "storage": {
                      "ephemeralStorage": {
                        "storageSize": 1024
                      },
                      "shmSize": 64
                    },
                    "docker": {
                      "configType": "default"
                    }
                  },
                  "vcsData": {
                    "projectType": "github",
                    "projectUrl": "${args.GIT_REPO}",
                    "projectBranch": "${args.GIT_BRANCH}"
                  },
                  "buildSettings": {
                    "dockerfile": {
                      "buildEngine": "kaniko",
                      "dockerFilePath": "/FullstackTemplate.Bff/Dockerfile",
                      "dockerWorkDir": "/"
                    }
                  },
                  "ports": [
                    {
                      "name": "http",
                      "internalPort": 8080,
                      "protocol": "HTTP",
                      "public": true,
                      "domains": [],
                      "security": {
                        "policies": [],
                        "credentials": []
                      },
                      "disableNfDomain": false
                    }
                  ],
                  "healthChecks": [
                    {
                      "type": "livenessProbe",
                      "protocol": "HTTP",
                      "path": "/health",
                      "port": 8080,
                      "initialDelaySeconds": 10,
                      "periodSeconds": 30,
                      "timeoutSeconds": 5,
                      "failureThreshold": 3
                    }
                  ],
                  "runtimeEnvironment": {
                    "services__server__http__0": "http://server:8080"
                  },
                  "runtimeFiles": {},
                  "buildArguments": {},
                  "buildFiles": {},
                  "disabledCI": false,
                  "buildConfiguration": {
                    "pathIgnoreRules": [],
                    "isAllowList": false,
                    "ciIgnoreFlagsEnabled": false
                  }
                }
              }
//#if (UseAuthentik)
              ,{
                "kind": "DeploymentService",
                "ref": "authentik-server",
                "spec": {
                  "name": "authentik-server",
                  "billing": {
                    "deploymentPlan": "nf-compute-20"
                  },
                  "deployment": {
                    "instances": 1,
                    "storage": {
                      "ephemeralStorage": {
                        "storageSize": 1024
                      },
                      "shmSize": 64
                    },
                    "external": {
                      "imagePath": "ghcr.io/goauthentik/server:2024.12"
                    }
                  },
                  "ports": [
                    {
                      "name": "http",
                      "internalPort": 9000,
                      "protocol": "HTTP",
                      "public": true,
                      "domains": [],
                      "security": {
                        "policies": [],
                        "credentials": []
                      },
                      "disableNfDomain": false
                    }
                  ],
                  "healthChecks": [
                    {
                      "type": "livenessProbe",
                      "protocol": "HTTP",
                      "path": "/-/health/live/",
                      "port": 9000,
                      "initialDelaySeconds": 30,
                      "periodSeconds": 30,
                      "timeoutSeconds": 10,
                      "failureThreshold": 5
                    }
                  ],
                  "runtimeEnvironment": {
                    "AUTHENTIK_BOOTSTRAP_PASSWORD": "${args.AUTHENTIK_BOOTSTRAP_PASSWORD}",
                    "AUTHENTIK_BOOTSTRAP_EMAIL": "${args.AUTHENTIK_BOOTSTRAP_EMAIL}",
                    "AUTHENTIK_SECRET_KEY": "${args.AUTH_CLIENT_SECRET}",
                    "AUTHENTIK_ERROR_REPORTING__ENABLED": "false"
                  },
                  "runtimeFiles": {}
                }
              },
              {
                "kind": "DeploymentService",
                "ref": "authentik-worker",
                "spec": {
                  "name": "authentik-worker",
                  "billing": {
                    "deploymentPlan": "nf-compute-20"
                  },
                  "deployment": {
                    "instances": 1,
                    "storage": {
                      "ephemeralStorage": {
                        "storageSize": 1024
                      },
                      "shmSize": 64
                    },
                    "external": {
                      "imagePath": "ghcr.io/goauthentik/server:2024.12"
                    },
                    "cmdOverride": "worker"
                  },
                  "runtimeEnvironment": {
                    "AUTHENTIK_SECRET_KEY": "${args.AUTH_CLIENT_SECRET}",
                    "AUTHENTIK_ERROR_REPORTING__ENABLED": "false"
                  },
                  "runtimeFiles": {}
                }
              }
//#endif
            ]
          }
        }
      ]
    }
  },
  "options": {
    "autorun": false,
    "concurrencyPolicy": "allow"
  },
  "gitops": {
    "repoUrl": "TODO: Insert your git repo URL here",
    "vcsService": "github",
    "accountLogin": "TODO: Insert your GitHub account login here",
    "branch": "main",
    "filePath": "/northflank.json"
  },
  "$schema": "https://api.northflank.com/v1/schemas/template"
}